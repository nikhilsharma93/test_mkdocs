



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Deployment</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.3020aac5.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#deployment" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="Deployment" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            Deployment
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="Deployment" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Deployment
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="docs/README.md" title="Reamde" class="md-nav__link">
      Reamde
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" title="Table of Contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction:" class="md-nav__link">
    Introduction:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" title="Concepts:" class="md-nav__link">
    Concepts:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#component" title="Component:" class="md-nav__link">
    Component:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline" title="Pipeline:" class="md-nav__link">
    Pipeline:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-library" title="Function Library:" class="md-nav__link">
    Function Library:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io-handling" title="I/O Handling:" class="md-nav__link">
    I/O Handling:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variable-namespace" title="Variable Namespace:" class="md-nav__link">
    Variable Namespace:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-a-component" title="Initializing a Component:" class="md-nav__link">
    Initializing a Component:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-a-pipeline" title="Initializing a Pipeline:" class="md-nav__link">
    Initializing a Pipeline:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-component" title="Building a Component:" class="md-nav__link">
    Building a Component:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-input-variables" title="Setting Input Variables:" class="md-nav__link">
    Setting Input Variables:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#passing-static-component-variables" title="Passing Static Component Variables:" class="md-nav__link">
    Passing Static Component Variables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-runtime-component-variables" title="Passing Runtime Component Variables:" class="md-nav__link">
    Passing Runtime Component Variables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-static-pipeline-variables" title="Passing Static Pipeline Variables:" class="md-nav__link">
    Passing Static Pipeline Variables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-pipeline-run-variables" title="Passing Pipeline-run Variables:" class="md-nav__link">
    Passing Pipeline-run Variables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-pipeline-map-variables" title="Passing Pipeline-map Variables:" class="md-nav__link">
    Passing Pipeline-map Variables:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-output-variables" title="Setting Output Variables:" class="md-nav__link">
    Setting Output Variables:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variable-sharing-routines" title="Variable Sharing Routines:" class="md-nav__link">
    Variable Sharing Routines:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variable-deletion-routines" title="Variable Deletion Routines:" class="md-nav__link">
    Variable Deletion Routines:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-pipeline" title="Building a Pipeline:" class="md-nav__link">
    Building a Pipeline:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-a-pipeline" title="Running a Pipeline:" class="md-nav__link">
    Running a Pipeline:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-a-summary-of-pipeline-runs" title="Getting a Summary of Pipeline Runs" class="md-nav__link">
    Getting a Summary of Pipeline Runs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiprocessing" title="Multiprocessing:" class="md-nav__link">
    Multiprocessing:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ways-to-multiprocess" title="Ways to Multiprocess" class="md-nav__link">
    Ways to Multiprocess
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiprocessing-within-pipeline" title="Multiprocessing Within Pipeline" class="md-nav__link">
    Multiprocessing Within Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiprocessing-across-pipeline" title="Multiprocessing Across Pipeline" class="md-nav__link">
    Multiprocessing Across Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comparison-of-multiprocessing-vs-not" title="Comparison of Multiprocessing vs Not" class="md-nav__link">
    Comparison of Multiprocessing vs Not
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-examples" title="Basic Examples:" class="md-nav__link">
    Basic Examples:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-pipeline" title="Basic Pipeline:" class="md-nav__link">
    Basic Pipeline:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#printing-variables" title="Printing Variables:" class="md-nav__link">
    Printing Variables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-variables" title="Saving Variables:" class="md-nav__link">
    Saving Variables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-static-pipeline-variables" title="Adding Static Pipeline Variables:" class="md-nav__link">
    Adding Static Pipeline Variables:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-examples" title="Advanced Examples:" class="md-nav__link">
    Advanced Examples:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wrapping-pipeline-inside-another-pipeline" title="Wrapping Pipeline inside another Pipeline:" class="md-nav__link">
    Wrapping Pipeline inside another Pipeline:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sharing-component-variables-across-pipelines" title="Sharing Component Variables across Pipelines:" class="md-nav__link">
    Sharing Component Variables across Pipelines:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-examples" title="Task Examples:" class="md-nav__link">
    Task Examples:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiprocessing-examples" title="Multiprocessing Examples:" class="md-nav__link">
    Multiprocessing Examples:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributing-to-function-library" title="Contributing to Function Library:" class="md-nav__link">
    Contributing to Function Library:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#component-function-requirements" title="Component Function Requirements:" class="md-nav__link">
    Component Function Requirements:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repeator" title="Repeator:" class="md-nav__link">
    Repeator:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exception-handling" title="Exception Handling:" class="md-nav__link">
    Exception Handling:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-pointers" title="Quick Pointers:" class="md-nav__link">
    Quick Pointers:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="deployment">Deployment</h1>
<p><img alt="" src="utils/_aux/mix_logo.png" /></p>
<p><br/><br/></p>
<h2 id="table-of-contents">Table of Contents</h2>
<p><a href="#introduction">Introduction</a></p>
<p><a href="#concepts">Concepts</a></p>
<p><a href="#initializing-a-component">Initializing a Component</a></p>
<p><a href="#initializing-a-pipeline">Initializing a Pipeline</a></p>
<p><a href="#building-a-component">Building a Component</a></p>
<ul>
<li>
<p><a href="#setting-input-variables">Setting Input Variables</a></p>
</li>
<li>
<p><a href="#setting-output-variables">Setting Output Variables</a></p>
</li>
<li>
<p><a href="#variable-sharing-routines">Variable Sharing Routines</a></p>
</li>
<li>
<p><a href="#variable-deletion-routines">Variable Deletion Routines</a></p>
</li>
</ul>
<p><a href="#building-a-pipeline">Building a Pipeline</a></p>
<p><a href="#running-a-pipeline">Running a Pipeline</a></p>
<p><a href="#getting-a-summary-of-pipeline-runs">Getting a Summary of Pipeline Runs</a></p>
<p><a href="#multiprocessing">Multiprocessing</a></p>
<p><a href="#basic-examples">Basic Examples</a></p>
<p><a href="#advanced-examples">Advanced Examples</a></p>
<p><a href="#task-examples">Task Examples</a></p>
<p><a href="#multiprocessing-examples">Multiprocessing Examples</a></p>
<p><a href="#debugging">Debugging</a></p>
<p><a href="#logging">Logging</a></p>
<p><a href="#contributing-to-function-library">Contributing to Function Library</a></p>
<p><a href="#component-function-requirements">Component Function Requirements</a></p>
<p><a href="#repeator">Repeator</a></p>
<p><a href="#exception-handling">Exception Handling</a></p>
<p><a href="#quick-pointers">Quick Pointers</a></p>
<p><a href="#requirements">Requirements</a></p>
<p><br/><br/></p>
<h2 id="introduction">Introduction:</h2>
<p>This framework provides a way to set up model deployment from reusable and modular components. The aim is to generalize how models are deployed at DL, although the tools within this might be useful for other tasks as well.</p>
<blockquote>
<p>TIP: You can add the model to a Google bucket and provide the model path as <code>/festivus/&lt;path_to_model_in_googlestorage&gt;</code></p>
</blockquote>
<p><br/><br/></p>
<h2 id="concepts">Concepts:</h2>
<h3 id="component">Component:</h3>
<p>This is the most basic unit of work, that wraps a python function, and controls which variables are fed to it and which ones are returned. Every python function that needs to be run should be wrapped in a Component.
See <a href="#component-function-requirements">Component Function Requirements</a></p>
<h3 id="pipeline">Pipeline:</h3>
<p>An ordered collection of Components, that provides method to execute its components in either a serial or a multiprocessing fashion. A Component cannot be run on its own, and needs to go inside a pipeline.</p>
<h3 id="function-library">Function Library:</h3>
<p>A set of commonly useful functions that can be imported from this library to build Components.
See <a href="#contributing-to-function-library">Contributing to Function Library</a></p>
<h3 id="io-handling">I/O Handling:</h3>
<p>Components, when put inside a pipeline, are not automatically connected. The user needs connect them by specifying, for each Component, where it is getting the input variables from, and what variables should be returned at the end of its execution.</p>
<h3 id="variable-namespace">Variable Namespace:</h3>
<p>Since a user controls all the variable flow in a pipeline, it is crucial to understand the scope of each variable created.
- <code>Static Component Variables</code>: These are visible only to the Component they are set with. Intended use case is to pass all those input variables to a Component function that have a static value and are not needed in any other Component. Consider this to be the equivalent of wrapping the function with <code>functools.partial</code>
- <code>Runtime Component Variables</code>: These can be configured to receive values at runtime (i.e the point where the corresponding component function will be run), and can be shared with any other component. Intended use case is to pass I/O values between different components as the pipeline runs.
- <code>Static Pipeline Variables</code>: These are visible to every Component that exists in the pipeline. Intended use case is to set all those input variables to a Component function that have a pre-determinable and static value, and are needed in two or more Components. As an alternative, you could use <code>Static Component Variables</code> and set them in each Component definition, but it could get redundant and tedious.</p>
<blockquote>
<p>NOTE: Components handle automatic deletion of <code>Runtime Component Variables</code> (from the same pipeline) once no longer required. See <a href="#variable-deletion-routines">Variable Deletion Routines</a></p>
<p>NOTE: <code>Static Pipeline Variables</code> can be accessed even by components that are not part of that pipeline.</p>
</blockquote>
<p><br/><br/></p>
<h2 id="initializing-a-component">Initializing a Component:</h2>
<p>This is the fist step to creating a Component. The user must provide a unique name for it, and a python function that it wraps.
You can do it like
<div class="highlight"><pre><span></span><span class="c1"># If the function exists in the function library, pass it as a string</span>
<span class="n">comp</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_comp&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;func_in_library&#39;</span><span class="p">)</span>

<span class="c1"># If it is a function defined elsewhere, pass the handle</span>
<span class="k">def</span> <span class="nf">my_func</span><span class="p">:</span>
  <span class="o">...</span>

<span class="n">comp</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_comp&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func</span><span class="p">)</span>
</pre></div>
You could pass additional arguments for <a href="#debugging">debugging</a>, and <a href="#multiprocessing-within-pipeline">multiprocessing</a></p>
<p><br/><br/></p>
<h2 id="initializing-a-pipeline">Initializing a Pipeline:</h2>
<p>This is the fist step to creating a Pipeline. The user must provide a unique name for it.
You can do it like
<div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_pipeline&#39;</span><span class="p">)</span>
</pre></div></p>
<p><br/><br/></p>
<h2 id="building-a-component">Building a Component:</h2>
<p>Once initialized, you should configure I/O variable routines among other optional things.
The user provides where a component gets its input variables from, and what output variables of a component function are recorded (to be used by other components, later in the pipeline). You can optionally do things like saving and printing the variable values at the end of a component execution.</p>
<p><br/><br/></p>
<h2 id="setting-input-variables">Setting Input Variables:</h2>
<p>There are three ways of passing input values to a function of a component
- By setting <code>Component level static_args</code> for static values for that Component (the alternative being <code>functools.partial</code>)
- By setting <code>Component level runtime_args</code> for values that are made available at runtime (eg. the output of a previous component in the pipeline).
- By setting <code>Pipeline level static_args</code> for static values for one/more Components in that Pipeline (the alternative being <code>functools.partial</code> for each Component that needs it). If you set a variable this way, you should only try to access it via <code>Component level runtime_args</code>, and not <code>Component level static_args</code>
- (<em>WARNING</em>: This works only if a component is the first one in a pipeline) By passing a keyword argument for that value to the <code>run</code> or <code>map</code> method of a pipeline which this component is the first member of.</p>
<p>The following cases explain ways to do all the above.</p>
<h6 id="passing-static-component-variables">Passing Static Component Variables:</h6>
<p>Set <code>static_args</code> attribute of a Component. It accepts a dictionary, where each key is the name to set, and each value is the variable value to assign to the name.
<div class="highlight"><pre><span></span><span class="n">comp</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
<span class="n">comp</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">products</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;usda:naip:rgbn:v1&#39;</span><span class="p">],</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">])</span>
<span class="c1"># Every time the Component&#39;s function is run, these values are passed to it.</span>
</pre></div></p>
<h6 id="passing-runtime-component-variables">Passing Runtime Component Variables:</h6>
<p>If a Component function should get some of its input values from a <code>Runtime Component Variable</code> or a <code>Pipeline Variable</code> (this could be either because the value is coming from a previous step in the pipeline at runtime, or because the value is coming from a preset Pipeline Variable), you should use the <code>runtime_args</code> attribute of a Component to let it know where it should get the inputs from. It accepts a dictionary <code>(key, value)</code>, where each <code>key</code> is the name of the variable (in the component's function definition) that the value is passed to, and each <code>value</code> is variable that would be passed. Every <code>key</code> is of <code>str</code> type, and every <code>value</code> takes either <code>&lt;component_obj&gt;.FutureVariable.&lt;variable_name&gt;</code> or <code>&lt;pipeline_obj&gt;.FutureVariable.&lt;variable_name&gt;</code> depending on where it is coming from. Note that you cannot provide any other variable as a <code>value</code>. Also, variable names starting with single or double underscore are prohibited.
<div class="highlight"><pre><span></span><span class="c1"># Let&#39;s create two components that we intend to run serially</span>
<span class="k">def</span> <span class="nf">my_func1</span><span class="p">(</span><span class="n">tilesize</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;comp1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_func2</span><span class="p">(</span><span class="n">tilesize</span><span class="p">):</span>
  <span class="n">tilesize</span> <span class="o">+=</span> <span class="mi">2</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
<span class="n">comp2</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;comp2&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func2</span><span class="p">)</span>

<span class="c1"># Now, if comp1 is the first in a pipeline, we need to pass an initial value for `tilesize`</span>
<span class="c1"># One way to do this is to set it as a static arg</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tilesize</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<span class="c1"># Alternatively, I could use functools.partial and not set a static_arg:</span>
<span class="n">my_func1</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">my_func1</span><span class="p">,</span> <span class="n">tilesize</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;comp1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func1</span><span class="p">)</span>

<span class="c1"># As for comp2, it gets the tilesize from whatever comp1 returns as tilesize.</span>
<span class="c1"># To do this, specify the runtime_arg of comp2 to get its `tilesize` from the output value of `tilesize` of comp1</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tilesize</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">tilesize</span><span class="p">)</span>
<span class="c1"># NOTE: we should also ask comp1 to record its output `tilesize` so that comp2 can access it.</span>
<span class="c1"># We look at it in the next section, &quot;Setting Output Variables&quot;</span>
</pre></div></p>
<h6 id="passing-static-pipeline-variables">Passing Static Pipeline Variables:</h6>
<p>Use the <code>add_pipeline_variable</code> method of a Pipeline to set any Static Pipeline Variable. It accepts a dictionary, where each key is the name to set, and each value is the variable value to assign to the name. Access them via specifying the value in a Component's <code>runtime_args</code> attribute.
<div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_pipeline_variable</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">unpadded_tilesize</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Now I can use this in any component.</span>
<span class="c1"># For example, if I want to use this as the `tilesize` input argument for comp1 from the</span>
<span class="c1"># previous example, I could do:</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tilesize</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">unpadded_tilesize</span><span class="p">)</span>
<span class="c1"># And I will not need to do comp1.static_args = dict(tilesize=1024)</span>

<span class="c1"># NOTE: It is illegal to pass in a pipeline variable as to static_args of a component</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tilesize</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">unpadded_tilesize</span><span class="p">)</span>  <span class="c1"># Illegal</span>
</pre></div></p>
<p><strong>See <a href="#variable-sharing-routines">Variable Sharing Routines</a> to understand what variable values might get overwritten</strong></p>
<p><strong>For understanding the lifetime of all these variables, see <a href="#variable-deletion-routines">Variable Deletion Routines</a></strong></p>
<h6 id="passing-pipeline-run-variables">Passing Pipeline-run Variables:</h6>
<p>This is useful when a pipeline is wrapped inside another pipeline, and some arguments need to be passed during the execution of the outer pipeline to the inner pipeline. Use <code>inner_pipeline.run(kwargs=&lt;kwargs&gt;)</code>. See <a href="#wrapping-pipeline-inside-another-pipeline">Wrapping Pipeline inside another Pipeline</a> for an example.</p>
<h6 id="passing-pipeline-map-variables">Passing Pipeline-map Variables:</h6>
<p>Analogous to <code>Passing Pipeline-run Variables</code>, this method is useful when you are doing a <code>map</code> call on a pipeline instead of a <code>run</code> call (see <a href="#multiprocessing-across-pipeline">Multiprocessing Across Pipeline</a>). You could do <code>inner_pipeline.map(kwargs=&lt;kwargs&gt;)</code>. See <a href="#multiprocessing-examples">Multiprocessing Examples</a></p>
<p><br/><br/></p>
<h2 id="setting-output-variables">Setting Output Variables:</h2>
<p>A user can specify which variables from a function should the Component record at the end of its execution, so that it can be made available for use by other components in that/other pipeline(s). Use the <code>to_record</code> attribute of a Component to specify these variables. It accepts a dictionary <code>(key, value)</code>, where <code>key</code> is the name of the variable in the component's function and <code>value</code> is the name by which you want this variable to be stored in the pipeline.</p>
<p><strong>Names for <code>value</code> starting with single or double underscore are prohibited.</strong></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_func</span><span class="p">():</span>
  <span class="n">a1</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="n">a2</span> <span class="o">=</span> <span class="mi">6</span>
  <span class="n">a1</span> <span class="o">+=</span> <span class="mi">7</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="n">comp</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_comp&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func</span><span class="p">)</span>
<span class="n">comp</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="s1">&#39;my_a1&#39;</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="s1">&#39;a2&#39;</span><span class="p">)</span>

<span class="c1"># Whenever this comp is run as part of the pipeline, at the end of the execution of my_func,</span>
<span class="c1"># the values `a1` and `a2` are stored as `my_a1` and `a2` in that component `comp`.</span>
<span class="c1"># Any component that runs after this component can then access those values as</span>
<span class="c1"># comp.FutureVariable.my_a1, and comp.FutureVariable.a2</span>

<span class="c1"># It is important to note that the value of a variable that gets recorded is the one that exists</span>
<span class="c1"># just before the function returns. Intermediate values cannot be recorded/accessed.</span>
<span class="c1"># In this example, the value of a1=5 cannot be recorded.</span>
</pre></div>

<p><strong>It is illegal to ask a component to record a variable but never use it. The framework will throw an exception.</strong></p>
<p><br/><br/></p>
<h2 id="variable-sharing-routines">Variable Sharing Routines:</h2>
<p>Components allow variable sharing by providing a routine like <code>&lt;component_obj&gt;.FutureVariable.&lt;variable_name&gt;</code>. When recording a variable and passing it as a <code>runtime_arg</code> for another component via this routine, care must be taken if the component functions are doing in-place operations.
Consider the following example
<div class="highlight"><pre><span></span><span class="n">inp_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">my_func1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;I am func1. I received: &#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mi">5</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">my_func2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;I am func2. I received: &#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mi">10</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">my_func3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;I am func3. I received: &#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="s1">&#39;comp1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func1</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">inp_image</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">comp2</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="s1">&#39;comp2&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func2</span><span class="p">)</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">comp3</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="s1">&#39;comp3&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">my_func3</span><span class="p">)</span>
<span class="n">comp3</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="s1">&#39;my_pipeline&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">,</span> <span class="n">comp3</span><span class="p">])</span>

<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Here, the output looks like this:</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">func1</span><span class="o">.</span> <span class="n">I</span> <span class="n">received</span><span class="p">:</span>  <span class="p">[[</span><span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span> <span class="mf">0.</span><span class="p">]]</span>

<span class="n">I</span> <span class="n">am</span> <span class="n">func2</span><span class="o">.</span> <span class="n">I</span> <span class="n">received</span><span class="p">:</span>  <span class="p">[[</span><span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span> <span class="mf">5.</span><span class="p">]]</span>

<span class="n">I</span> <span class="n">am</span> <span class="n">func3</span><span class="o">.</span> <span class="n">I</span> <span class="n">received</span><span class="p">:</span>  <span class="p">[[</span><span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span><span class="p">]</span>
<span class="p">[</span><span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span> <span class="mf">15.</span><span class="p">]]</span>

<span class="c1"># Even though we were intending to pass the output of comp1 to comp3, the fact that comp2 did an</span>
<span class="c1"># in-place modification to `x` in my_func2 meant that when it was time for `comp1.FutureVariable.x`</span>
<span class="c1"># to get evaluated by comp3, it was already modified.</span>
</pre></div></p>
<p>The framework allows you to access component variables from components belonging to a different pipeline, but there are certain implications leading to them remaining in memory throughout the life of the program. See <a href="#variable-deletion-routines">Variable Deletion Routines</a></p>
<p><br/><br/></p>
<h2 id="variable-deletion-routines">Variable Deletion Routines:</h2>
<p>In consideration of being memory efficient, this framework runs a cleanup job after running every component, and deletes all (*) those variables that are no longer needed.</p>
<p>Consider the following example
<div class="highlight"><pre><span></span><span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c1_x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">comp2</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c2_x</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">comp3</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">comp3</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c3_x</span><span class="o">=</span><span class="n">comp2</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">,</span> <span class="n">comp3</span><span class="p">])</span>
</pre></div>
When the pipeline is run, the order of execution of components is <code>comp1-&gt;comp2-&gt;comp3</code>. After <code>comp2</code> uses <code>comp1.FutureVariable.x</code>, it is no longer needed, because <code>comp3</code> does not use it. As such, the framework goes ahead and deletes <code>comp1.FutureVariable.x</code>.</p>
<p>This deletion behavior is True for all such variables with the following restrictions:
- Variables coming from <code>Pipeline Static Args</code> are not deleted. The lifetime of such variables are as long as that Pipeline object is in scope.
- Variables coming from a component that runs in another pipeline are not deleted. This is because the source pipeline does not know if the destination pipeline is running in a loop or not. In the above example, if <code>comp1</code> was part of a different pipeline, then <code>comp1.FutureVariable.x</code> would not have been deleted. This aspect is crucial to understand when running pipelines in a loop and multiprocessing them (see <a href="#multiprocessing-within-pipeline">Multiprocessing Within Pipeline</a>)</p>
<p><br/><br/></p>
<h2 id="building-a-pipeline">Building a Pipeline:</h2>
<p>After you have built all the components, its time to put them in a pipeline and run them.
<div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_pipeline&#39;</span><span class="p">)</span>

<span class="c1"># Let&#39;s say we want to add the two components comp1 and comp2 (for reference, defined under the section</span>
<span class="c1"># &quot;Passing Runtime Component Variables&quot;, but not important)</span>

<span class="c1"># We add those components while compiling the pipeline</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">])</span>
</pre></div></p>
<blockquote>
<p>NOTE: Optionally, you can pass additional arguments for parallelizing and logging when compiling a pipeline. See <a href="#multiprocessing-within-pipeline">Multiprocessing Within Pipeline</a> and <a href="#logging">Logging</a></p>
</blockquote>
<p><br/><br/></p>
<h2 id="running-a-pipeline">Running a Pipeline:</h2>
<p>After you have compiled a pipeline, you can run it. You could either run it serially, or could multiprocess it.
<div class="highlight"><pre><span></span><span class="c1"># To run it serially</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=&lt;</span><span class="n">kwargs_to_pass</span><span class="o">&gt;</span><span class="p">)</span>
<span class="c1"># where kwargs_to_pass is useful if you want to pass initial inputs to the *first* component in that pipeline.</span>

<span class="c1"># If you want to multiprocess within pipelines</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=&lt;</span><span class="n">kwargs_to_pass</span><span class="o">&gt;</span><span class="p">)</span>
<span class="c1"># Additionally, you would have set the pipeline to parallelize on compilation</span>

<span class="c1"># If you want to multiprocess across pipelines (this is different from multiprocessing within a pipeline)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=&lt;</span><span class="n">kwargs_to_pass</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)</span>
</pre></div>
See <a href="#wrapping-pipeline-inside-another-pipeline">an example</a> for understand the <code>run</code> method.
See <a href="#multiprocessing-within-pipeline">Multiprocessing Within Pipeline</a> for details on additional steps for that case.
See <a href="#multiprocessing-across-pipeline">Multiprocessing Across Pipeline</a> for details on the <code>map</code> method.</p>
<p>The output to stdout includes timestamp, PID stamp, component name stamp, and run count stamp (i.e <code>i</code> where that component is being executed for the <code>i</code><sup>th</sup> time). These stamps are essentially helpful when multiprocessing to separate out messages and logs.</p>
<p><br/><br/></p>
<h2 id="getting-a-summary-of-pipeline-runs">Getting a Summary of Pipeline Runs</h2>
<p>The framework is able to give you a summary (number of runs, time taken, order of execution, etc.) for the Pipeline runs that happen. By default, it prints th summary to stdout, but you could also save a graph-like summary to an image file on disk.
<div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="o">.</span><span class="n">summarize</span><span class="p">()</span>  <span class="c1"># This will print the summary to stdout</span>

<span class="n">Pipeline</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">visualize_path</span><span class="o">=</span><span class="s1">&#39;&lt;path&gt;&#39;</span><span class="p">)</span>  <span class="c1"># This will print and also save it to an image.</span>
</pre></div>
Whenever the <code>summarize</code> method is called, it is able to provide the summary for all runs done until that point. As such, to get a summary for the whole deployment, add this as the last line of the code.</p>
<p>Here is a summary of from the <a href="examples/wind_turbines/wind_turbines_parallel_within_pipeline.py">wind turbines example with multiprocessing</a></p>
<p><img alt="" src="examples/wind_turbines/summary_graph.png" /></p>
<p><br/><br/></p>
<h2 id="multiprocessing">Multiprocessing:</h2>
<p>This framework provides easy ways to multiprocess pipeline runs.</p>
<h3 id="ways-to-multiprocess">Ways to Multiprocess</h3>
<p>There are two ways one could multiprocess: <strong>within pipeline</strong> and <strong>across pipeline</strong></p>
<p><img alt="" src="utils/_aux/pipeline_3.png" /></p>
<h5 id="multiprocessing-within-pipeline">Multiprocessing Within Pipeline</h5>
<p>In this case the components of a pipeline run asynchronously, and if the pipeline is being run in a loop, each component in a given iteration of that loop is allowed to start processing as soon as the corresponding component from previous iteration completes its processing. As such, at any given instance, exactly one iteration-instance of a component will be running.</p>
<p>Each component can define its <code>max queue size</code> which controls how far ahead a component can be in the loop iteration with respect to other components that receive <code>runtime_args</code> from it.</p>
<table>
<thead>
<tr>
<th align="center">Pipeline</th>
<th align="center">Execution Graph - Component vs Time</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img alt="" src="utils/_aux/pipeline_1.png" /></td>
<td align="center"><img alt="" src="utils/_aux/pipeline_2.png" /></td>
</tr>
</tbody>
</table>
<p>To setup your pipeline to multiprocess this way, provide/do the following:</p>
<ul>
<li>[Optional; defaults to 1] <code>queue_size</code> on Component initialization, like <code>comp = Component(name=..., func=..., queue_size=2)</code>. This controls the <code>max queue size</code> mentioned above</li>
<li><code>parallelize=True</code> when compiling the pipeline, like <code>pipeline.compile_pipeline([comp1, comp2], parallelize=True)</code></li>
<li>Call <code>pipeline.wait()</code> after calling the <code>run</code> method on it. Unless you call this, the async process will be launched but the program will not wait for their completion. If you are running the pipelines in a loop, you could call the <code>wait</code> method towards the end. Like:</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>

<ul>
<li>[Optional; defaults to <code>True</code>] <code>run_async=False</code> on Component initialization if you want that specific component to run in the main process and not in a fork. This is helpful for cases like tensorflow model prediction. If you have a component that runs a <code>tf</code> model prediction, then it is not a good idea to launch it in a fork: (i) Tensorflow handles its own multiprocessing and doesn't like to be run in a separate forked process, and (ii) even if you do so, you will have to make sure that no <code>tf session</code> was initialized in the main process. It's just better to run the model prediction in the main process (this will also guarantee that at any given instance, there is only one model prediction running - thereby using full resources)</li>
</ul>
<p>If any components are set with <code>run_async=False</code>, then internally, the pipeline first launches all the async tasks, and then sequentially runs these non-async components in the main process. If running in a loop, then <em>all</em> async tasks (i.e from all the loop iterations) are asynchronously spun up, and then each the non-async components are run one after another. This does not mean that the non-async components are blocked until the async ones finish processing; they are only blocked until the async ones are spun up - which takes negligible amount of time.</p>
<p>If you are using this mode of multiprocessing, and if you have components from different pipelines share variables, then you cannot run <em>both</em> the pipelines in a loop at the same time. If you do, this will result in an infinite blocking after the first iteration of the source component.</p>
<p><strong>If you multiprocess this way, you are restricted to have any variables passed to <code>to_record</code> be serializable.</strong></p>
<blockquote>
<p>NOTE: There is no harm in calling <code>pipeline.wait()</code> even when <code>parallelize=False</code>. As such, when writing a generic component function that loops over a pipeline, it is a good idea to include <code>pipeline.wait()</code>, to allow parallelizing without having to change the function definition.</p>
</blockquote>
<h5 id="multiprocessing-across-pipeline">Multiprocessing Across Pipeline</h5>
<p>In this case the components within a pipeline run sequentially, but the pipeline runs themselves can be parallelized.
This is helpful if each component in your pipeline is not parallelizable (or scales across cores) by itself.
To setup your pipeline to multiprocess this way, provide/do the following:
- Instead of calling <code>pipeline.run</code>, use the <code>map</code> method and provide the number of cores to multiprocess with:
<div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">keys</span><span class="p">),</span> <span class="n">num_cores</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)</span>
<span class="c1"># The first kwarg here is similar to what `pipeline.run` supports</span>
</pre></div>
- There is no need to call the <code>wait</code> method; it is handled internally.</p>
<p><strong>At this time, you cannot multiprocess within and across pipeline at the same time</strong>.
As such, if you call the <code>map</code> method and have <code>parallelize=True</code> set during pipeline compilation, it will throw an exception. Also, when calling the <code>map</code> method, <code>queue_size</code> and <code>run_async</code> of a component are irrelevant.</p>
<h3 id="comparison-of-multiprocessing-vs-not">Comparison of Multiprocessing vs Not</h3>
<p>The following figure shows the advantage of multiprocessing within pipeline wrt the <a href="examples/wind_turbines/wind_turbines_parallel_within_pipeline.py">wind_turbines example</a>
<img alt="" src="examples/wind_turbines/time_compare.png" /></p>
<p>The following figure shows the advantage of multiprocessing across pipeline wrt the <a href="examples/sklearn/sklearn_parallel_across_pipeline.py">sklearn example</a>
<img alt="" src="examples/sklearn/time_compare.png" /></p>
<p><br/><br/></p>
<h2 id="basic-examples">Basic Examples:</h2>
<p>(For a full set of examples look under <a href="examples/">examples</a>)</p>
<h3 id="basic-pipeline">Basic Pipeline:</h3>
<p><a href="examples/basic_example.py">Code</a></p>
<p>Let us say you want to build a two-component pipeline.
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">deploy</span> <span class="kn">import</span> <span class="n">Component</span><span class="p">,</span> <span class="n">Pipeline</span>

<span class="n">inp_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

<span class="c1"># Let&#39;s say the two functions I want to use are demo1 and demo2 from the function library</span>

<span class="c1"># Create the first Component</span>
<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">)</span>
<span class="c1"># From the definition of demo1, we need to pass inp_image, add_value (optional), and mul_value (optional)</span>
<span class="c1"># We can pass these as Static Component variables since they are not needed elsewhere.</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">inp_image</span><span class="p">,</span> <span class="n">add_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mul_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># We want to get the final value of `inp_image` since that will need to be passed to demo2. So, record it.</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="s1">&#39;inp_image&#39;</span><span class="p">)</span>

<span class="c1"># Create the second Component</span>
<span class="n">comp2</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo2&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo2&#39;</span><span class="p">)</span>
<span class="c1"># From the definition of demo1, we need to pass inp_image and threshold_value. The former is a</span>
<span class="c1"># runtime argument that comes from the output of demo1, and threshold_value is a static argument.</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">threshold_value</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">inp_image</span><span class="p">)</span>
<span class="c1"># i.e Get the value, at that time in the future when this function is executed,</span>
<span class="c1"># stored by name `inp_image` in comp1 and pass it to comp2&#39;s function (i.e demo2)</span>
<span class="c1"># as the kwarg value for `inp_image`</span>

<span class="c1"># We do not want to record anything for this component since we don&#39;t need any output from it.</span>

<span class="c1"># Create a pipeline and add these components</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">])</span>
<span class="c1"># Run</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># Outputs</span>
<span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948031</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948138</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948152</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948393</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000151</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948446</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948457</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948768</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000212</span>
</pre></div></p>
<h3 id="printing-variables">Printing Variables:</h3>
<p><a href="examples/basic_example_print.py">Code</a></p>
<p>In debugging mode (or otherwise), it is helpful to print the state of variables between components. To achieve this, use the <code>to_print</code> attribute of a Component. It accepts a list of variable names that exist in the function definition of the component's function.
In our example with <code>comp2</code> (which uses <code>demo2</code>), let's say we want to print the value of the variable <code>dummy_variable</code>.
<div class="highlight"><pre><span></span><span class="n">comp2</span><span class="o">.</span><span class="n">to_print</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dummy_variable&#39;</span><span class="p">]</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># Outputs</span>
<span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365138</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365232</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365248</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365508</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000146</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365544</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365570</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365774</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="n">to_print</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365792</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="o">[</span><span class="n">to_print</span><span class="o">]</span> <span class="no">Value</span> <span class="n">of</span> <span class="n">dummy_variable</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365825</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="o">[</span><span class="n">to_print</span><span class="o">]</span> <span class="mi">5</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365960</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000316</span>

<span class="c1"># Note that you do not need to add a variable to `to_record` to print it.</span>
</pre></div></p>
<h3 id="saving-variables">Saving Variables:</h3>
<p><a href="examples/basic_example_save.py">Code</a></p>
<p>Just like printing variables, you can also save them. To achieve this, use the <code>to_save</code> attribute of a Component. It accepts a dictionary, where a <code>(key, value)</code> can be of two types:
- <code>(key, value) = (str, str)</code>: In this case, provide the <code>key</code> with the variable you are trying to save, and provide the full save path as the <code>value</code>. The method to save is inferred from the extension of the save path. Currently, saving <code>numpy</code> files (<code>.npy</code>), and images (<code>.png</code> or <code>.jpg</code>) is supported.
- <code>(key, value) = (str, function)</code>: In this case, <code>key</code> remains the same as above, but in <code>value</code> provide a python function handle that would take in the positional argument (0th position) of the value of <code>key</code> at runtime and would save it according to the custom method.</p>
<p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dummy_save</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;I am a dummy save method; will not save anything. But I confirm to have received the variable {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">to_save</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="s1">&#39;_aux/test_inp_image.npy&#39;</span><span class="p">,</span> <span class="n">dummy_variable</span><span class="o">=</span><span class="n">dummy_save</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># Outputs</span>
<span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105548</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105655</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105669</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105897</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000140</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105961</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105972</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">106237</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Saving</span><span class="o">...</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">dummy</span> <span class="n">save</span> <span class="nb">method</span><span class="p">;</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">save</span> <span class="n">anything</span><span class="o">.</span> <span class="no">But</span> <span class="n">I</span> <span class="n">confirm</span> <span class="n">to</span> <span class="n">have</span> <span class="n">received</span> <span class="n">the</span> <span class="n">variable</span> <span class="mi">5</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">109076</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">003014</span>

<span class="c1"># Also, _aux/test_inp_image.npy gets saved</span>

<span class="c1"># Note that you do not need to add a variable to `to_record` to save it.</span>
</pre></div></p>
<h3 id="adding-static-pipeline-variables">Adding Static Pipeline Variables:</h3>
<p><a href="examples/basic_example_static_pipeline_variable.py">Code</a></p>
<p>In our basic example, let us say we use <code>demo3</code> from the function library instead of <code>demo2</code> (and as such, <code>comp3</code> instead of <code>comp2</code>), and we want to use the same value for the argument <code>add_value</code> in both <code>demo1</code> and <code>demo3</code>. One way to do this is to add it as <code>static_args</code> in both the components. The other way is to add it as a static pipeline variable just once, and let both the components access it.
<div class="highlight"><pre><span></span><span class="n">inp_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

<span class="c1"># Initialize a pipeline, and set the pipeline variable `add_value`</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_pipeline_variable</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">add_value</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">inp_image</span><span class="p">,</span> <span class="n">mul_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">add_value</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">add_value</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="s1">&#39;inp_image&#39;</span><span class="p">)</span>

<span class="n">comp3</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo3&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo3&#39;</span><span class="p">)</span>
<span class="n">comp3</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">inp_image</span><span class="p">,</span> <span class="n">add_value</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">add_value</span><span class="p">)</span>

<span class="c1"># Note that `compile_pipeline` should be the last operation performed on the pipeline before</span>
<span class="c1"># calling the `.run` on it</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp3</span><span class="p">])</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># Outputs</span>
<span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808513</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808601</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808614</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808841</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">00012</span><span class="mi">8</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808874</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo3</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808885</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo3</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="n">I</span> <span class="n">received</span> <span class="n">the</span> <span class="n">add_value</span> <span class="ss">as</span><span class="p">:</span>  <span class="mi">5</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">809067</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo3</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">0000</span><span class="mi">94</span>
</pre></div></p>
<p><br/><br/></p>
<h2 id="advanced-examples">Advanced Examples:</h2>
<h3 id="wrapping-pipeline-inside-another-pipeline">Wrapping Pipeline inside another Pipeline:</h3>
<p>Consider the case when you have a pipeline that you want to run inside a loop. A simple way to do this would be like
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="o">...</span><span class="p">:</span>
  <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">inp_x</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>
</pre></div></p>
<p>But if the <code>for</code> loop had to be part of a Component, which in turn was a part of a Pipeline, then there is a little more to do.</p>
<p>Consider the example where you have a list of two dlkeys, and want to run a model over each of them.
The inner most pipeline then looks like (get image) + (run model prediction).</p>
<p>Let's create a dummy pipeline for this
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">products</span><span class="p">):</span>
  <span class="n">dltile</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">dltile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">model_predict</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">inp_image</span><span class="p">):</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inp_image</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="n">comp0</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_image&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">get_image</span><span class="p">)</span>
<span class="n">comp0</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">products</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;usda:naip:rgbn:v1&#39;</span><span class="p">])</span>
<span class="n">comp0</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;out_image&#39;</span><span class="p">)</span>
<span class="c1"># We do not provide any value for `key` right now since it will come from an outer pipeline at runtime.</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_predict&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">model_predict</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp0</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">out_image</span><span class="p">)</span>

<span class="n">inner_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;inner_pipeline&#39;</span><span class="p">)</span>
<span class="n">inner_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp0</span><span class="p">,</span> <span class="n">comp1</span><span class="p">])</span>

<span class="c1"># Now we need an outer pipeline that has one component that gets the keys and another component</span>
<span class="c1"># that loops over the keys and passes them sequentially to the inner pipeline.</span>
<span class="c1"># If required, you could append other components to the outer pipeline, and they will get executed once the</span>
<span class="c1"># inner pipeline is done processing all the keys in the loop.</span>

<span class="k">def</span> <span class="nf">get_keys</span><span class="p">():</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1024:0:1.0:-3:2&#39;</span><span class="p">,</span> <span class="s1">&#39;1024:0:1.0:-10:4&#39;</span><span class="p">]</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">loop_keys</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loop_keys</span><span class="p">:</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
    <span class="c1"># This is where the argument `key` is getting passed to `get_image` of comp0.</span>
    <span class="c1"># Note that declaration of such a function loop_keys limits what pipeline can be used with it:</span>
    <span class="c1"># The first component of that pipeline &quot;should&quot; accept an argument for `key`</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="n">comp_main0</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_keys&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">get_keys</span><span class="p">)</span>
<span class="n">comp_main0</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;dlkeys&#39;</span><span class="p">)</span>

<span class="n">comp_main1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;loop_keys&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">loop_keys</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">inner_pipeline</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">comp_main0</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">dlkeys</span><span class="p">)</span>

<span class="n">outer_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;outer_pipeline&#39;</span><span class="p">)</span>
<span class="n">outer_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp_main0</span><span class="p">,</span> <span class="n">comp_main1</span><span class="p">])</span>
<span class="n">outer_pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div></p>
<h3 id="sharing-component-variables-across-pipelines">Sharing Component Variables across Pipelines:</h3>
<p>In the <a href="#wrapping-pipeline-inside-another-pipeline">above example</a>, you would notice that the same model is being loaded twice inside the inner pipeline. A better way to do this is to load the model once, in the outer pipeline, and then share the variable with the corresponding component in the inner pipeline. This applies to any such use case, where sharing removes redundancy.
<div class="highlight"><pre><span></span><span class="c1"># Create a component for loading the model</span>
<span class="k">def</span> <span class="nf">model_loader</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="c1"># Modify the definition of `model_predict` in the previous example to not load the model</span>
<span class="k">def</span> <span class="nf">model_predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inp_image</span><span class="p">):</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inp_image</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="c1"># Create the outer pipeline</span>
<span class="n">comp_main0</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># Same as the get_keys component above</span>

<span class="n">comp_main1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_loader&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">model_loader</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_path</span><span class="o">=...</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;loaded_model&#39;</span><span class="p">)</span>

<span class="n">comp_main2</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># Same as the loop_keys component above (called as comp_main1 in that example)</span>

<span class="n">outer_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp_main0</span><span class="p">,</span> <span class="n">comp_main1</span><span class="p">,</span> <span class="n">comp_main2</span><span class="p">])</span>


<span class="c1"># Create the inner pipeline</span>
<span class="n">comp0</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># Same as in the above example</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_predict&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">model_predict</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp0</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">out_image</span><span class="p">,</span>
                          <span class="n">model</span><span class="o">=</span><span class="n">comp_main1</span><span class="o">.</span><span class="n">FutureVariable</span><span class="o">.</span><span class="n">shared_model</span><span class="p">)</span>

<span class="n">inner_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp0</span><span class="p">,</span> <span class="n">comp1</span><span class="p">])</span>
</pre></div></p>
<p><br/><br/></p>
<h2 id="task-examples">Task Examples:</h2>
<p>Some caution needs to be taken when defining pipelines that work with DLTasks.
The main tricky point is that Tasks can only take a serializable function as its input.
Therefore, any pipeline that you want to run within Tasks should be wrapped in a python function.</p>
<p>Example: <a href="examples/wind_turbines/wind_turbines_noparallel.py">Wind Turbines Example</a></p>
<p><br/><br/></p>
<h2 id="multiprocessing-examples">Multiprocessing Examples:</h2>
<p>See <a href="examples/wind_turbines/wind_turbines_parallel_within_pipeline.py">an example for multiprocessing within pipeline</a></p>
<p>See <a href="examples/sklearn/sklearn_parallel_across_pipeline.py">an example for multiprocessing across pipeline</a></p>
<p><br/><br/></p>
<h2 id="contributing-to-function-library">Contributing to Function Library:</h2>
<p>Every function in the function library must exist in one of the following states:
- <code>Component Function</code>: These functions are meant to used with Components, and have some requirements.
See <a href="#component-function-requirements">Component Function Requirements</a>
- <code>Helper Function</code>: These functions are meant to used within Component Functions (<strong>NOT</strong> Components). They should just be regular python functions, returning whatever variables applicable.
Example: <a href="func_library.py#L181">model_predict_func</a>  # TODO - Update</p>
<p><br/><br/></p>
<h2 id="component-function-requirements">Component Function Requirements:</h2>
<p>These should be regular python functions with just one requirement:
They should return either:
- (<strong>Preferably</strong>) <code>Subset of locals()</code>: Use this to provide the subset of variables that you think are all that an end-user will ever want to access. This will avoid returning unnecessary, intermediate, and garbage variables. The return statement would look something like <code>return {'var1': value1, 'var2': value2, ...}</code>
- (<strong>Avoid as much as possible)</strong> <code>locals()</code>: The user can then choose whatever variables they want from this function as the outputs.
The return statement would look like <code>return locals()</code></p>
<blockquote>
<p>NOTE: Do not return a subset of <code>locals()</code> just because you feel it is memory efficient. Whether you return <code>locals()</code> or not, you would just be returning a reference to it; there is no memory overhead.</p>
</blockquote>
<p><br/><br/></p>
<h2 id="repeator">Repeator:</h2>
<p>When providing input dictionaries for <code>Component.to_record</code> (as an example), it might get tedious to do something like: <code>Component.to_record = dict(batch_imgs='batch_imgs', pad='pad', tile='tile', res='res')</code>. Instead, you could use <code>deploy.repeator</code> to avoid the repetition:
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">deploy</span> <span class="kn">import</span> <span class="n">repeator</span>

<span class="n">Component</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="n">repeator</span><span class="p">(</span><span class="s1">&#39;batch_imgs&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="s1">&#39;tile&#39;</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">)</span>

<span class="c1"># You could also pass kwargs</span>
<span class="n">Component</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="n">repeator</span><span class="p">(</span><span class="s1">&#39;batch_imgs&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="s1">&#39;tile1&#39;</span><span class="p">)</span>
</pre></div></p>
<p><br/><br/></p>
<h2 id="exception-handling">Exception Handling:</h2>
<p>To make debugging easier, the Pipeline handles some exceptions efficiently for you to quickly understand what went wrong.
- <code>KeyExistingError</code>: You would see this exception in case you try to overwrite an existing pipeline key by either trying to add a Pipeline Variable (via <code>.add_pipeline_variable</code>) that has a name clash, or by trying to <code>share_from</code> or <code>share_with</code> Pipeline Variables that have a name clash (because they already exist with that name in the other pipeline).
- <code>KeyNonExistentError</code>: You would see this exception in case you try to access pipeline variables that do not exist because either you did not set them (via <code>.add_pipeline_variable</code>), or they did not get recorded (via <code>.to_record</code>), or you provided an incorrect name.</p>
<p>Any errors in the function definition, or otherwise are handled by python natively.</p>
<p><br/><br/></p>
<h2 id="quick-pointers">Quick Pointers:</h2>
<ul>
<li>You can pass keyword arguments to the kwarg <code>kwargs</code> of a <code>pipeline.run</code> command. These will internally be passed to (and only to) the first component in that pipeline.</li>
<li>Never add anything to a pipeline after calling the <code>compile_pipeline</code> method on it</li>
<li>If you are confused to see example functions return <code>locals()</code> or a similar dictionary, then read <a href="#contributing-to-function-library">Contributing to Function Library</a> and <a href="#component-function-requirements">Component Function Requirements</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
  </body>
</html>