



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Examples - Deployment</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#basic-examples" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Deployment" class="md-header-nav__button md-logo">
          
            <img src="../utils/_aux/deploy_logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Deployment
            </span>
            <span class="md-header-nav__topic">
              Examples
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Deployment" class="md-nav__button md-logo">
      
        <img src="../utils/_aux/deploy_logo.png" width="48" height="48">
      
    </a>
    Deployment
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" checked>
    
    <label class="md-nav__link" for="nav-1">
      Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Examples
      </label>
    
    <a href="./" title="Examples" class="md-nav__link md-nav__link--active">
      Examples
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-examples" title="Basic Examples" class="md-nav__link">
    Basic Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-pipeline" title="Basic Pipeline" class="md-nav__link">
    Basic Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#printing-variables" title="Printing Variables" class="md-nav__link">
    Printing Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-variables" title="Saving Variables" class="md-nav__link">
    Saving Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-static-pipeline-variables" title="Adding Static Pipeline Variables" class="md-nav__link">
    Adding Static Pipeline Variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-examples" title="Advanced Examples" class="md-nav__link">
    Advanced Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wrapping-pipeline-inside-another-pipeline" title="Wrapping Pipeline inside another Pipeline" class="md-nav__link">
    Wrapping Pipeline inside another Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sharing-component-variables-across-pipelines" title="Sharing Component Variables across Pipelines" class="md-nav__link">
    Sharing Component Variables across Pipelines
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-examples" title="Task Examples" class="md-nav__link">
    Task Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiprocessing-examples" title="Multiprocessing Examples" class="md-nav__link">
    Multiprocessing Examples
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="General" class="md-nav__link">
      General
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../FUNC_DOCS/" title="Functions and Methods" class="md-nav__link">
      Functions and Methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../INSTALLATION/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-examples" title="Basic Examples" class="md-nav__link">
    Basic Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-pipeline" title="Basic Pipeline" class="md-nav__link">
    Basic Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#printing-variables" title="Printing Variables" class="md-nav__link">
    Printing Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-variables" title="Saving Variables" class="md-nav__link">
    Saving Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-static-pipeline-variables" title="Adding Static Pipeline Variables" class="md-nav__link">
    Adding Static Pipeline Variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-examples" title="Advanced Examples" class="md-nav__link">
    Advanced Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wrapping-pipeline-inside-another-pipeline" title="Wrapping Pipeline inside another Pipeline" class="md-nav__link">
    Wrapping Pipeline inside another Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sharing-component-variables-across-pipelines" title="Sharing Component Variables across Pipelines" class="md-nav__link">
    Sharing Component Variables across Pipelines
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-examples" title="Task Examples" class="md-nav__link">
    Task Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiprocessing-examples" title="Multiprocessing Examples" class="md-nav__link">
    Multiprocessing Examples
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Examples</h1>
                
                <h2 id="basic-examples"><strong>Basic Examples</strong></h2>
<p>(For a full set of examples look under <a href="https://github.com/descarteslabs/appsci_utils/blob/deploy_generalize/appsci_utils/deployment/examples/">examples</a>)</p>
<h3 id="basic-pipeline"><strong>Basic Pipeline</strong></h3>
<p><a href="https://github.com/descarteslabs/appsci_utils/blob/deploy_generalize/appsci_utils/deployment/examples/basic_example.py">Code</a></p>
<p>Let us say you want to build a two-component pipeline.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">appsci_utils.deployment.deploy</span> <span class="kn">import</span> <span class="n">Component</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">repeator</span>

<span class="n">inp_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

<span class="c1"># Let&#39;s say the two functions I want to use are demo1 and demo2 from the function library</span>

<span class="c1"># Create the first Component</span>
<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">)</span>
<span class="c1"># From the definition of demo1, we need to pass inp_image, add_value (optional), and mul_value (optional)</span>
<span class="c1"># We can pass these as Static Component variables since they are not needed elsewhere.</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">inp_image</span><span class="p">,</span> <span class="n">add_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mul_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># We want to get the final value of `inp_image` since that will need to be passed to demo2. So, record it.</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="s1">&#39;inp_image&#39;</span><span class="p">)</span>

<span class="c1"># Create the second Component</span>
<span class="n">comp2</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo2&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo2&#39;</span><span class="p">)</span>
<span class="c1"># From the definition of demo1, we need to pass inp_image and threshold_value. The former is a</span>
<span class="c1"># runtime argument that comes from the output of demo1, and threshold_value is a static argument.</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">threshold_value</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">inp_image</span><span class="p">)</span>
<span class="c1"># i.e Get the value, at that time in the future when this function is executed,</span>
<span class="c1"># stored by name `inp_image` in comp1 and pass it to comp2&#39;s function (i.e demo2)</span>
<span class="c1"># as the kwarg value for `inp_image`</span>

<span class="c1"># We do not want to record anything for this component since we don&#39;t need any output from it.</span>

<span class="c1"># Create a pipeline and add these components</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">])</span>
<span class="c1"># Run</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

</div>
<div class="admonition success">
<p class="admonition-title">Output</p>
<div class="highlight"><pre><span></span><span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948031</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948138</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948152</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948393</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000151</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948446</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948457</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mo">02</span><span class="o">.</span><span class="mi">948768</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21641</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000212</span>
</pre></div>

</div>
<h3 id="printing-variables"><strong>Printing Variables</strong></h3>
<p><a href="https://github.com/descarteslabs/appsci_utils/tree/deploy_generalize/appsci_utils/deployment/examples/basic_example_print.py">Code</a></p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="n">comp2</span><span class="o">.</span><span class="n">to_print</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dummy_variable&#39;</span><span class="p">]</span>
</pre></div>

</div>
<div class="admonition success">
<p class="admonition-title">Output</p>
<div class="highlight"><pre><span></span><span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365138</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365232</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365248</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365508</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000146</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365544</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365570</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365774</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="n">to_print</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365792</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="o">[</span><span class="n">to_print</span><span class="o">]</span> <span class="no">Value</span> <span class="n">of</span> <span class="n">dummy_variable</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365825</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="o">[</span><span class="n">to_print</span><span class="o">]</span> <span class="mi">5</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span><span class="o">.</span><span class="mi">365960</span><span class="o">][</span><span class="no">PID</span> <span class="mi">21956</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000316</span>

<span class="c1"># Note that you do not need to add a variable to `to_record` to print it.</span>
</pre></div>

</div>
<h3 id="saving-variables"><strong>Saving Variables</strong></h3>
<p><a href="https://github.com/descarteslabs/appsci_utils/tree/deploy_generalize/appsci_utils/deployment/examples/basic_example_save.py">Code</a></p>
<p>Just like printing variables, you can also save them. To achieve this, use the <code>to_save</code> attribute of a Component. It accepts a dictionary, where a <code>(key, value)</code> can be of two types:
- <code>(key, value) = (str, str)</code>: In this case, provide the <code>key</code> with the variable you are trying to save, and provide the full save path as the <code>value</code>. The method to save is inferred from the extension of the save path. Currently, saving <code>numpy</code> files (<code>.npy</code>), and images (<code>.png</code> or <code>.jpg</code>) is supported.
- <code>(key, value) = (str, function)</code>: In this case, <code>key</code> remains the same as above, but in <code>value</code> provide a python function handle that would take in the positional argument (0th position) of the value of <code>key</code> at runtime and would save it according to the custom method.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dummy_save</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;I am a dummy save method; will not save anything.&#39;</span> <span class="o">+</span>
          <span class="s1">&#39;But I confirm to have received the variable {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
<span class="n">comp2</span><span class="o">.</span><span class="n">to_save</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="s1">&#39;test_inp_image.npy&#39;</span><span class="p">,</span> <span class="n">dummy_variable</span><span class="o">=</span><span class="n">dummy_save</span><span class="p">)</span>
</pre></div>

</div>
<div class="admonition success">
<p class="admonition-title">Output</p>
<div class="highlight"><pre><span></span><span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105548</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105655</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105669</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105897</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">000140</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105961</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">105972</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">106237</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Saving</span><span class="o">...</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">dummy</span> <span class="n">save</span> <span class="nb">method</span><span class="p">;</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">save</span> <span class="n">anything</span><span class="o">.</span> <span class="no">But</span> <span class="n">I</span> <span class="n">confirm</span> <span class="n">to</span> <span class="n">have</span> <span class="n">received</span> <span class="n">the</span> <span class="n">variable</span> <span class="mi">5</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mo">04</span><span class="o">.</span><span class="mi">109076</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22064</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo2</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">003014</span>

<span class="c1"># Also, test_inp_image.npy gets saved</span>

<span class="c1"># Note that you do not need to add a variable to `to_record` to save it.</span>
</pre></div>

</div>
<h3 id="adding-static-pipeline-variables"><strong>Adding Static Pipeline Variables</strong></h3>
<p><a href="https://github.com/descarteslabs/appsci_utils/tree/deploy_generalize/appsci_utils/deployment/examples/basic_example_static_pipeline_variable.py">Code</a></p>
<p>In our basic example, let us say we use <code>demo3</code> from the function library instead of <code>demo2</code> (and as such, <code>comp3</code> instead of <code>comp2</code>), and we want to use the same value for the argument <code>add_value</code> in both <code>demo1</code> and <code>demo3</code>. One way to do this is to add it as <code>static_args</code> in both the components. The other way is to add it as a static pipeline variable just once, and let both the components access it.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="n">inp_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

<span class="c1"># Initialize a pipeline, and set the pipeline variable `add_value`</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_pipeline_variable</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">add_value</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo1&#39;</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">inp_image</span><span class="p">,</span> <span class="n">mul_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">add_value</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">add_value</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="s1">&#39;inp_image&#39;</span><span class="p">)</span>

<span class="n">comp3</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo3&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;demo3&#39;</span><span class="p">)</span>
<span class="n">comp3</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp1</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">inp_image</span><span class="p">,</span> <span class="n">add_value</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">add_value</span><span class="p">)</span>

<span class="c1"># Note that `compile_pipeline` should be the last operation performed on the pipeline before</span>
<span class="c1"># calling the `.run` on it</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp3</span><span class="p">])</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

</div>
<div class="admonition success">
<p class="admonition-title">Output</p>
<div class="highlight"><pre><span></span><span class="c1"># Outputs</span>
<span class="no">RUNNING</span> <span class="no">PIPELINE</span> <span class="s2">&quot;demo&quot;</span><span class="o">...</span> <span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808513</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808601</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808614</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808841</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo1</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">00012</span><span class="mi">8</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808874</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo3</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Starting</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">808885</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo3</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Running</span> <span class="no">Function</span><span class="o">...</span>
<span class="n">I</span> <span class="n">received</span> <span class="n">the</span> <span class="n">add_value</span> <span class="ss">as</span><span class="p">:</span>  <span class="mi">5</span>
<span class="o">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">19</span><span class="o">.</span><span class="mi">809067</span><span class="o">][</span><span class="no">PID</span> <span class="mi">22861</span><span class="o">][</span><span class="no">Comp</span> <span class="n">demo3</span><span class="o">][</span><span class="n">n_time</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span> <span class="no">Compute</span> <span class="no">Ended</span><span class="o">.</span> <span class="no">Took</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="o">.</span><span class="mo">0000</span><span class="mi">94</span>
</pre></div>

</div>
<p><br/><br/></p>
<h2 id="advanced-examples"><strong>Advanced Examples</strong></h2>
<h3 id="wrapping-pipeline-inside-another-pipeline"><strong>Wrapping Pipeline inside another Pipeline</strong></h3>
<p>Consider the case when you have a pipeline that you want to run inside a loop. A simple way to do this would be like</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="o">...</span><span class="p">:</span>
  <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">inp_x</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>
</pre></div>

</div>
<p>But if the <code>for</code> loop had to be part of a Component, which in turn was a part of a Pipeline, then there is a little more to do.</p>
<p>Consider the example where you have a list of two dlkeys, and want to run a model over each of them.
The inner most pipeline then looks like (get image) + (run model prediction).</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">products</span><span class="p">):</span>
  <span class="n">dltile</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">dltile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">model_predict</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">inp_image</span><span class="p">):</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inp_image</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="n">comp0</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_image&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">get_image</span><span class="p">)</span>
<span class="n">comp0</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">products</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;usda:naip:rgbn:v1&#39;</span><span class="p">])</span>
<span class="n">comp0</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;out_image&#39;</span><span class="p">)</span>
<span class="c1"># We do not provide any value for `key` right now since it will come from an outer pipeline at runtime.</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_predict&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">model_predict</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp0</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">out_image</span><span class="p">)</span>

<span class="n">inner_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;inner_pipeline&#39;</span><span class="p">)</span>
<span class="n">inner_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp0</span><span class="p">,</span> <span class="n">comp1</span><span class="p">])</span>

<span class="c1"># Now we need an outer pipeline that has one component that gets the keys and another component</span>
<span class="c1"># that loops over the keys and passes them sequentially to the inner pipeline.</span>
<span class="c1"># If required, you could append other components to the outer pipeline, and they will get executed once the</span>
<span class="c1"># inner pipeline is done processing all the keys in the loop.</span>

<span class="k">def</span> <span class="nf">get_keys</span><span class="p">():</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1024:0:1.0:-3:2&#39;</span><span class="p">,</span> <span class="s1">&#39;1024:0:1.0:-10:4&#39;</span><span class="p">]</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">loop_keys</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loop_keys</span><span class="p">:</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
    <span class="c1"># This is where the argument `key` is getting passed to `get_image` of comp0.</span>
    <span class="c1"># Note that declaration of such a function loop_keys limits what pipeline can be used with it:</span>
    <span class="c1"># The first component of that pipeline &quot;should&quot; accept an argument for `key`</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="n">comp_main0</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_keys&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">get_keys</span><span class="p">)</span>
<span class="n">comp_main0</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;dlkeys&#39;</span><span class="p">)</span>

<span class="n">comp_main1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;loop_keys&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">loop_keys</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">inner_pipeline</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">comp_main0</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">dlkeys</span><span class="p">)</span>

<span class="n">outer_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;outer_pipeline&#39;</span><span class="p">)</span>
<span class="n">outer_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp_main0</span><span class="p">,</span> <span class="n">comp_main1</span><span class="p">])</span>
<span class="n">outer_pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

</div>
<h3 id="sharing-component-variables-across-pipelines"><strong>Sharing Component Variables across Pipelines</strong></h3>
<p>In the <a href="#wrapping-pipeline-inside-another-pipeline">above example</a>, you would notice that the same model is being loaded twice inside the inner pipeline. A better way to do this is to load the model once, in the outer pipeline, and then share the variable with the corresponding component in the inner pipeline. This applies to any such use case, where sharing removes redundancy.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><span class="c1"># Create a component for loading the model</span>
<span class="k">def</span> <span class="nf">model_loader</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="c1"># Modify the definition of `model_predict` in the previous example to not load the model</span>
<span class="k">def</span> <span class="nf">model_predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inp_image</span><span class="p">):</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inp_image</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="c1"># Create the outer pipeline</span>
<span class="n">comp_main0</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># Same as the get_keys component above</span>

<span class="n">comp_main1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_loader&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">model_loader</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">static_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_path</span><span class="o">=...</span><span class="p">)</span>
<span class="n">comp_main1</span><span class="o">.</span><span class="n">to_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;loaded_model&#39;</span><span class="p">)</span>

<span class="n">comp_main2</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># Same as the loop_keys component above (called as comp_main1 in that example)</span>

<span class="n">outer_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp_main0</span><span class="p">,</span> <span class="n">comp_main1</span><span class="p">,</span> <span class="n">comp_main2</span><span class="p">])</span>


<span class="c1"># Create the inner pipeline</span>
<span class="n">comp0</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># Same as in the above example</span>

<span class="n">comp1</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;model_predict&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">model_predict</span><span class="p">)</span>
<span class="n">comp1</span><span class="o">.</span><span class="n">runtime_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inp_image</span><span class="o">=</span><span class="n">comp0</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">out_image</span><span class="p">,</span>
                          <span class="n">model</span><span class="o">=</span><span class="n">comp_main1</span><span class="o">.</span><span class="n">future_variable</span><span class="o">.</span><span class="n">shared_model</span><span class="p">)</span>

<span class="n">inner_pipeline</span><span class="o">.</span><span class="n">compile_pipeline</span><span class="p">([</span><span class="n">comp0</span><span class="p">,</span> <span class="n">comp1</span><span class="p">])</span>
</pre></div>

</div>
<p><br/><br/></p>
<h2 id="task-examples"><strong>Task Examples</strong></h2>
<p>Some caution needs to be taken when defining pipelines that work with DLTasks.
The main tricky point is that Tasks can only take a serializable function as its input.
Therefore, any pipeline that you want to run within Tasks should be wrapped in a python function.</p>
<p>Example: <a href="https://github.com/descarteslabs/appsci_utils/tree/deploy_generalize/appsci_utils/deployment/examples/wind_turbines/wind_turbines_noparallel.py">Wind Turbines Example</a></p>
<p><br/><br/></p>
<h2 id="multiprocessing-examples"><strong>Multiprocessing Examples</strong></h2>
<p>See <a href="https://github.com/descarteslabs/appsci_utils/tree/deploy_generalize/appsci_utils/deployment/examples/wind_turbines/wind_turbines_parallel_within_pipeline.py">an example for multiprocessing within pipeline</a></p>
<p>See <a href="https://github.com/descarteslabs/appsci_utils/tree/deploy_generalize/appsci_utils/deployment/examples/sklearn/sklearn_parallel_across_pipeline.py">an example for multiprocessing across pipeline</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href=".." title="General" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                General
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>